@page
@model sadnerd.io.ATAS.OrderEventHub.Models.Pages.TopstepAccounts.CreateModel
@{
    ViewData["Title"] = "Add ProjectX Account";
}

<h1>Add ProjectX Account</h1>

<div class="row">
    <div class="col-md-6">
        <form method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            
            <div class="form-group mb-3">
                <label for="ProjectXAccountId" class="form-label">ProjectX Account ID</label>
                <input type="text" class="form-control" id="ProjectXAccountId" name="ProjectXAccount.ProjectXAccountId" required />
                <span asp-validation-for="ProjectXAccount.ProjectXAccountId" class="text-danger"></span>
            </div>
            
            <div class="form-group mb-3">
                <label for="Vendor" class="form-label">Vendor</label>
                <select class="form-control" id="Vendor" name="ProjectXAccount.Vendor" asp-items="Model.AvailableVendors" required>
                    <option value="">-- Select Vendor --</option>
                </select>
                <span asp-validation-for="ProjectXAccount.Vendor" class="text-danger"></span>
            </div>
            
            <div class="form-group mb-3">
                <label for="ApiCredentialId" class="form-label">API Credentials</label>
                <select class="form-control" id="ApiCredentialId" name="ProjectXAccount.ApiCredentialId" required>
                    <option value="">-- Select API Credentials --</option>
                </select>
                <span asp-validation-for="ProjectXAccount.ApiCredentialId" class="text-danger"></span>
                <small class="form-text text-muted">
                    <a asp-page="/ApiCredentials/Index" target="_blank">Manage API Credentials</a>
                </small>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Add</button>
                <a asp-page="./Index" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('Vendor').addEventListener('change', function() {
            const vendorId = this.value;
            const credentialSelect = document.getElementById('ApiCredentialId');
            
            // Clear existing options
            credentialSelect.innerHTML = '<option value="">-- Select API Credentials --</option>';
            
            if (vendorId) {
                fetch(`?handler=ApiCredentials&vendorId=${vendorId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(credential => {
                            const option = document.createElement('option');
                            option.value = credential.id;
                            option.textContent = credential.displayName;
                            credentialSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading credentials:', error);
                    });
            }
        });
    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
